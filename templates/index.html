<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroXAI - Parkinson's Disease Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #3b82f6;
            --accent-color: #ef4444;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --bg-light: #f8fafc;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border-light: #e2e8f0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--text-dark);
            background-color: var(--bg-light);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
            color: white !important;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .card {
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            background: white;
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom: none;
            border-radius: 16px 16px 0 0 !important;
            padding: 1.25rem 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            z-index: 1;
        }

        .card-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid var(--border-light);
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            background-color: var(--bg-light);
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background-color: white;
        }

        .form-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%231e293b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-size: 12px;
        }

        .input-group {
            border-radius: 12px;
            overflow: hidden;
        }

        .input-group .form-control {
            border-right: none;
        }

        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-secondary {
            background-color: #f1f5f9;
            border: 1px solid var(--border-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
            transform: translateY(-2px);
        }

        .result-box {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-check-input:checked {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .feature-importance {
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .page-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .lead {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
        }

        #predictionContent {
            padding: 1rem;
            border-radius: 8px;
        }

        #predictionContent p {
            margin-bottom: 0.5rem;
        }

        #predictionContent ul {
            list-style: none;
            padding-left: 0;
        }

        #predictionContent ul li {
            padding: 0.3rem 0;
            color: var(--text-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-box {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">NeuroXAI</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/reports">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row justify-content-center mb-4">
            <div class="col-md-10 text-center">
                <h1 class="page-title">Parkinson's Disease Prediction with XAI</h1>
                <p class="lead">Advanced machine learning analysis with explainable AI insights</p>
            </div>
        </div>

        <div class="row">
            <!-- Status Card -->
            <div class="col-md-12 mb-3">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>System Status:</strong>
                            <span id="systemStatus" class="ms-2 text-muted">Loading...</span>
                            <small class="text-muted ms-3" id="modelsLoaded"></small>
                        </div>
                        <div>
                            <button id="repairBtn" class="btn btn-secondary btn-sm">Repair Preprocessor</button>
                            <button id="reloadModelsBtn" class="btn btn-outline-primary btn-sm ms-2">Reload Models</button>
                            <a href="/reports" class="btn btn-primary btn-sm ms-2">View Reports</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Input Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Input Features</h5>
                    </div>
                    <div class="card-body">
                        <form id="predictionForm">
                            <div class="mb-3">
                                <label for="modelSelect" class="form-label">Select Model</label>
                                <select class="form-select" id="modelSelect" required>
                                    <!-- options populated dynamically from /api/models -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Medical Features</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Age</label>
                                        <input type="number" class="form-control" name="Age" placeholder="Age" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">BMI</label>
                                        <input type="number" class="form-control" name="BMI" step="0.01" placeholder="BMI" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Physical Activity</label>
                                        <input type="number" class="form-control" name="PhysicalActivity" placeholder="Physical Activity (hours/week)" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Clinical Measures</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Blood Pressure (Systolic)</label>
                                        <input type="number" class="form-control" name="SystolicBP" placeholder="Systolic BP" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Blood Pressure (Diastolic)</label>
                                        <input type="number" class="form-control" name="DiastolicBP" placeholder="Diastolic BP" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Sleep Quality</label>
                                        <input type="number" class="form-control" name="SleepQuality" min="0" max="10" placeholder="Sleep Quality (0-10)" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Symptoms</label>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="Tremor" id="tremor">
                                            <label class="form-check-label" for="tremor">Tremor</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="Rigidity" id="rigidity">
                                            <label class="form-check-label" for="rigidity">Rigidity</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="Bradykinesia" id="bradykinesia">
                                            <label class="form-check-label" for="bradykinesia">Bradykinesia</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="PosturalInstability" id="posturalInstability">
                                            <label class="form-check-label" for="posturalInstability">Postural Instability</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Medical History</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="FamilyHistoryParkinsons" id="familyHistory">
                                            <label class="form-check-label" for="familyHistory">Family History</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="Depression" id="depression">
                                            <label class="form-check-label" for="depression">Depression</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="Hypertension" id="hypertension">
                                            <label class="form-check-label" for="hypertension">Hypertension</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-brain"></i> Predict
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="explainPrediction()">
                                    <i class="fas fa-chart-bar"></i> Explain
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Batch Prediction</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Upload CSV File</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload & Predict</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Missing features modal -->
            <div class="modal fade" id="missingModal" tabindex="-1" aria-labelledby="missingModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="missingModalLabel">Missing Features Detected</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                                <div class="modal-body">
                                    <p class="text-muted">The system detected missing features required by the model. Review and accept basic defaults to run a quick prediction, or accept recommended defaults to include additional features from training. You can edit any value before proceeding.</p>

                                    <h6>Basic (essential) features</h6>
                                    <div class="table-responsive mb-3">
                                        <table class="table table-sm" id="missingFeaturesBasicTable">
                                            <thead>
                                                <tr>
                                                    <th>Feature</th>
                                                    <th>Default Value</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                    <h6>Recommended (additional) features</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm" id="missingFeaturesRecommendedTable">
                                            <thead>
                                                <tr>
                                                    <th>Feature</th>
                                                    <th>Default Value</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="acceptDefaultsBtn" class="btn btn-primary">Proceed with defaults</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="predictionResult" class="result-box" style="display: none;">
                            <h4>Prediction</h4>
                            <div id="predictionContent"></div>
                        </div>

                        <div id="explanationResult" class="result-box" style="display: none;">
                            <h4>Explanation</h4>
                            <div id="explanationContent"></div>
                            <div id="featureImportance" class="feature-importance"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // Read CSS variables for use in JS (colors)
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles.getPropertyValue('--primary-color').trim() || '#2563eb';
        const accentColor = rootStyles.getPropertyValue('--accent-color').trim() || '#ef4444';
        // Feature name mapping (form name -> model expected name)
        const featureMap = {
            'Age': 'Age',
            'BMI': 'BMI',
            'PhysicalActivity': 'Physical Activity',
            'SystolicBP': 'Blood Pressure (Systolic)',
            'DiastolicBP': 'Blood Pressure (Diastolic)',
            'SleepQuality': 'Sleep Quality',
            'Tremor': 'Tremor',
            'Rigidity': 'Rigidity',
            'Bradykinesia': 'Bradykinesia',
            'PosturalInstability': 'Postural Instability',
            'FamilyHistoryParkinsons': 'Family History',
            'Depression': 'Depression',
            'Hypertension': 'Hypertension'
        };

        // Helper: map form features to model feature names
        function mapFeatures(formFeatures) {
            const mapped = {};
            for (const [k, v] of Object.entries(formFeatures)) {
                const mappedName = featureMap[k] || k;
                mapped[mappedName] = v;
            }
            return mapped;
        }

        // Check missing features compared to preprocessor feature list
        function findMissingFeatures(mappedFeatures) {
            if (!preprocessorInfo || !preprocessorInfo.feature_names) return [];
            const expected = preprocessorInfo.feature_names;
            const missing = [];
            expected.forEach(fname => {
                if (!(fname in mappedFeatures) || mappedFeatures[fname] === undefined || Number.isNaN(mappedFeatures[fname])) {
                    const defaultVal = (preprocessorInfo.feature_means && preprocessorInfo.feature_means[fname] !== undefined) ? preprocessorInfo.feature_means[fname] : 0;
                    missing.push({ feature: fname, default: defaultVal });
                }
            });
            return missing;
        }

        // Show modal with missing features and defaults (split into Basic and Recommended)
        function showMissingModal(missing, onAccept) {
            // Clear existing tables
            const basicBody = document.querySelector('#missingFeaturesBasicTable tbody');
            const recBody = document.querySelector('#missingFeaturesRecommendedTable tbody');
            basicBody.innerHTML = '';
            recBody.innerHTML = '';

            // friendly fallbacks for core features
            const friendly = {
                'Age': 50,
                'BMI': 25,
                'Physical Activity': 3,
                'DietQuality': 3,
                'Blood Pressure (Systolic)': 120,
                'Blood Pressure (Diastolic)': 80,
                'SystolicBP': 120,
                'DiastolicBP': 80,
                'Sleep Quality': 7,
                'Tremor': 0,
                'Rigidity': 0,
                'Bradykinesia': 0,
                'Postural Instability': 0,
                'Family History': 0,
                'Family History Parkinsons': 0,
                'FamilyHistoryParkinsons': 0,
                'Hypertension': 0,
                'Diabetes': 0,
                'Smoking': 0,
                'AlcoholConsumption': 0,
                'TraumaticBrainInjury': 0,
                'CholesterolTotal': 180,
                'CholesterolLDL': 100,
                'CholesterolHDL': 50,
                'CholesterolTriglycerides': 120,
                'UPDRS': 20,
                'MoCA': 26,
                'FunctionalAssessment': 80,
                'SpeechProblems': 0,
                'SleepDisorders': 0,
                'Constipation': 0,
                'Stroke': 0,
                'Diagnosis': 0,
                'DoctorInCharge': 0,
                'EducationLevel': 0,
                'Gender': 0,
                'Ethnicity': 0,
            };

            const { basic, recommended } = splitBasicRecommended(missing);

            function addRows(list, tbody) {
                list.forEach(m => {
                    const tr = document.createElement('tr');
                    const tdName = document.createElement('td');
                    tdName.textContent = m.feature;
                    const tdVal = document.createElement('td');
                    // Choose sensible default: friendly override -> preprocessor mean -> fallback 0
                    let val = (friendly.hasOwnProperty(m.feature) ? friendly[m.feature] : (m.default !== undefined ? m.default : 0));
                    // If the number is extremely small (training mean showed near-zero small floats), prefer 0 or friendly
                    if (typeof val === 'number' && Math.abs(val) < 1e-6) {
                        val = friendly[m.feature] !== undefined ? friendly[m.feature] : 0;
                    }
                    tdVal.innerHTML = `<input class="form-control form-control-sm" data-feature="${m.feature}" value="${val}" />`;
                    tr.appendChild(tdName);
                    tr.appendChild(tdVal);
                    tbody.appendChild(tr);
                });
            }

            addRows(basic, basicBody);
            addRows(recommended, recBody);

            const modal = new bootstrap.Modal(document.getElementById('missingModal'));
            modal.show();

            document.getElementById('acceptDefaultsBtn').onclick = function () {
                const defaults = {};
                const basicInputs = document.querySelectorAll('#missingFeaturesBasicTable tbody input');
                basicInputs.forEach(inp => {
                    const name = inp.getAttribute('data-feature');
                    const val = parseFloat(inp.value);
                    defaults[name] = Number.isNaN(val) ? 0 : val;
                });
                const recInputs = document.querySelectorAll('#missingFeaturesRecommendedTable tbody input');
                recInputs.forEach(inp => {
                    const name = inp.getAttribute('data-feature');
                    const val = parseFloat(inp.value);
                    if (!(name in defaults)) defaults[name] = Number.isNaN(val) ? 0 : val;
                });
                modal.hide();
                onAccept(defaults);
            };
        }

        // Helper: split missing features into Basic vs Recommended
        function splitBasicRecommended(missing) {
            // Define core basic features (minimal set needed for a reasonable quick prediction)
            const basicSet = new Set([
                'Age', 'BMI', 'Physical Activity', 'Blood Pressure (Systolic)', 'Blood Pressure (Diastolic)',
                'Sleep Quality', 'Family History', 'Hypertension', 'Diabetes', 'Bradykinesia', 'Postural Instability'
            ]);

            // Everything else is considered recommended (additional context)
            const basic = [];
            const recommended = [];
            missing.forEach(m => {
                if (basicSet.has(m.feature)) basic.push(m);
                else recommended.push(m);
            });
            return { basic, recommended };
        }

        async function doPredict(finalMappedFeatures) {
            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: document.getElementById('modelSelect').value, features: finalMappedFeatures })
                });
                const result = await response.json();
                if (!response.ok || result.error) {
                    const errMsg = result && result.error ? result.error : 'Prediction failed';
                    const details = result && result.details ? '\nDetails: ' + result.details : '';
                    alert(errMsg + details);
                    return;
                }
                displayPrediction(result);
            } catch (error) {
                console.error('Error:', error);
                alert('Error making prediction');
            }
        }

        // Form submission with missing-feature modal
        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const features = {};
            formData.forEach((value, key) => {
                if (document.querySelector(`input[name="${key}"]`)?.type === 'checkbox') {
                    features[key] = document.querySelector(`input[name="${key}"]`).checked ? 1 : 0;
                } else {
                    features[key] = value === '' ? NaN : parseFloat(value);
                }
            });

            const mapped = mapFeatures(features);
            const missing = findMissingFeatures(mapped);
            if (missing.length > 0) {
                showMissingModal(missing, (defaults) => {
                    // merge defaults into mapped and send
                    const final = { ...mapped };
                    Object.assign(final, defaults);
                    doPredict(final);
                });
            } else {
                await doPredict(mapped);
            }
        });

        // Global preprocessor info fetched from server
        let preprocessorInfo = null;

        // Load available models from server and populate model select
        async function loadAvailableModels() {
            try {
                const res = await fetch('/api/models');
                if (!res.ok) return;
                const models = await res.json();
                const sel = document.getElementById('modelSelect');
                sel.innerHTML = '';
                const entries = Object.keys(models);
                if (entries.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No models available';
                    sel.appendChild(opt);
                    sel.disabled = true;
                    return;
                }
                entries.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    // Make label prettier
                    opt.textContent = name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    sel.appendChild(opt);
                });
            } catch (e) {
                console.warn('Could not load models', e);
            }
        }

        // Load system health on page load
        async function loadSystemHealth() {
            try {
                const res = await fetch('/api/health');
                const info = await res.json();
                const statusEl = document.getElementById('systemStatus');
                const modelsEl = document.getElementById('modelsLoaded');
                if (info && info.status === 'healthy') {
                    statusEl.textContent = info.preprocessor && info.preprocessor.ready ? 'Ready (preprocessor OK)' : 'Degraded (preprocessor needs attention)';
                    modelsEl.textContent = `Models: ${info.model_names ? info.model_names.join(', ') : ''}`;
                    // also fetch preprocessor info for defaults
                    try {
                        const pi = await fetch('/api/preprocessor/info');
                        if (pi.ok) {
                            preprocessorInfo = await pi.json();
                        }
                    } catch (e) {
                        console.warn('Could not fetch preprocessor info', e);
                    }
                    // load available models into the select
                    loadAvailableModels();
                } else {
                    statusEl.textContent = 'Unavailable';
                }
            } catch (e) {
                console.warn('Could not load system health', e);
                document.getElementById('systemStatus').textContent = 'Error';
            }
        }

        document.getElementById('repairBtn').addEventListener('click', async () => {
            const btn = document.getElementById('repairBtn');
            btn.disabled = true;
            btn.textContent = 'Repairing...';
            try {
                const res = await fetch('/api/preprocessor/repair', { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    alert('Preprocessor repaired: ' + result.message);
                    // refresh preprocessor info after repair
                    try {
                        const pi = await fetch('/api/preprocessor/info');
                        if (pi.ok) preprocessorInfo = await pi.json();
                    } catch (e) { console.warn('Could not refresh preprocessor info', e); }
                } else {
                    alert('Repair failed: ' + (result.message || result.error || res.statusText));
                }
            } catch (e) {
                console.error('Repair error', e);
                alert('Error contacting server to repair preprocessor');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Repair Preprocessor';
                loadSystemHealth();
            }
        });

            document.getElementById('reloadModelsBtn').addEventListener('click', async () => {
                const btn = document.getElementById('reloadModelsBtn');
                btn.disabled = true;
                btn.textContent = 'Reloading...';
                try {
                    const res = await fetch('/api/models/reload', { method: 'POST' });
                    const r = await res.json();
                    if (res.ok) {
                        alert('Models reloaded: ' + (r.models || []).join(', '));
                        loadAvailableModels();
                    } else {
                        alert('Reload failed: ' + (r.error || res.statusText));
                    }
                } catch (e) {
                    console.error('Reload models error', e);
                    alert('Error reloading models');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Reload Models';
                    loadSystemHealth();
                }
            });

        // run initial health check
        loadSystemHealth();

        // File upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('file', document.getElementById('csvFile').files[0]);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!response.ok || result.error) {
                    const errMsg = result && result.error ? result.error : 'File upload failed';
                    const details = result && result.details ? '\nDetails: ' + result.details : '';
                    alert(errMsg + details);
                    return;
                }
                // Redirect to reports page to view generated reports
                window.location.href = '/reports';
            } catch (error) {
                console.error('Error:', error);
                alert('Error uploading file');
            }
        });

        // Explain prediction
        async function explainPrediction() {
            const formData = new FormData(document.getElementById('predictionForm'));
            const features = {};
            formData.forEach((value, key) => {
                // Handle checkboxes
                if (document.querySelector(`input[name="${key}"]`)?.type === 'checkbox') {
                    features[key] = document.querySelector(`input[name="${key}"]`).checked ? 1 : 0;
                } else {
                    features[key] = parseFloat(value);
                }
            });

            try {
                const response = await fetch('/api/explain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: document.getElementById('modelSelect').value,
                        features: features,
                        type: 'shap'
                    })
                });

                const result = await response.json();
                if (!response.ok || result.error) {
                    const errMsg = result && result.error ? result.error : 'Explanation failed';
                    const details = result && result.details ? '\nDetails: ' + result.details : '';
                    alert(errMsg + details);
                    return;
                }
                displayExplanation(result);
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating explanation');
            }
        }

        // Display prediction
        function displayPrediction(result) {
            const predictionDiv = document.getElementById('predictionResult');
            const contentDiv = document.getElementById('predictionContent');
            
            const predictionClass = result.prediction_class;
            const confidence = (result.confidence * 100).toFixed(1);
            const colorClass = predictionClass === 'Parkinson' ? 'text-danger' : 'text-success';
            
            contentDiv.innerHTML = `
                <div class="mb-3">
                    <h4 class="mb-2 ${colorClass}">${predictionClass}</h4>
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar ${colorClass === 'text-danger' ? 'bg-danger' : 'bg-success'}" 
                             role="progressbar" 
                             style="width: ${confidence}%" 
                             aria-valuenow="${confidence}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">Confidence: ${confidence}%</small>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex justify-content-between">
                            <span>No Parkinson:</span>
                            <span>${(result.probabilities['No Parkinson'] * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between">
                            <span>Parkinson:</span>
                            <span>${(result.probabilities['Parkinson'] * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            predictionDiv.style.display = 'block';
        }

        // Display explanation
        function displayExplanation(result) {
            const explanationDiv = document.getElementById('explanationResult');
            const contentDiv = document.getElementById('explanationContent');
            const importanceDiv = document.getElementById('featureImportance');
            
            contentDiv.innerHTML = `
                <div class="analysis-header mb-4">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-chart-line text-primary"></i>
                        <h5 class="mb-0">Analysis Details</h5>
                    </div>
                    <p class="text-muted mb-0 mt-2">Generated using ${result.type.toUpperCase()} analysis</p>
                </div>
            `;
            
            if (result.explanation && result.explanation.feature_importance) {
                // feature_importance may be list of [feature, value] tuples
                const fi = result.explanation.feature_importance;
                const xVals = fi.map(f => Array.isArray(f) ? f[1] : (f.importance ?? 0));
                const yVals = fi.map(f => Array.isArray(f) ? f[0] : (f.feature ?? ''));
                const colors = xVals.map(v => v >= 0 ? primaryColor : accentColor);

                const data = [{
                    type: 'bar',
                    x: xVals,
                    y: yVals,
                    orientation: 'h',
                    marker: {
                        color: colors,
                        opacity: 0.8
                    }
                }];
                
                const layout = {
                    title: {
                        text: 'Feature Importance Analysis',
                        font: {
                            family: 'Inter, sans-serif',
                            size: 18,
                            weight: 600
                        }
                    },
                    font: {
                        family: 'Inter, sans-serif'
                    },
                    margin: {
                        l: 200,
                        r: 20,
                        t: 40,
                        b: 50
                    },
                    xaxis: {
                        title: 'Impact on Prediction',
                        gridcolor: '#f1f5f9',
                        zerolinecolor: '#e2e8f0'
                    },
                    yaxis: {
                        gridcolor: '#f1f5f9'
                    },
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(255,255,255,0)',
                    showlegend: false
                };
                
                Plotly.newPlot(importanceDiv, data, layout);
            }
            
            explanationDiv.style.display = 'block';
        }
    </script>
</body>
</html>
